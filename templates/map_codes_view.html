<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Account <-> Tax Code Mapper with Map Names</title>
  <!-- Bootstrap CSS CDN -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
  >
  <style>
    body {
      background-color: #f5f5f7;
      color: #1d1d1f;
      font-family: -apple-system, BlinkMacSystemFont, "San Francisco",
                   "Helvetica Neue", Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    .container-fluid {
      margin-top: 20px;
      margin-bottom: 40px;
    }
    h1, h3, h4 {
      font-weight: 600;
    }
    .tab-content {
      border: 1px solid #ccc;
      border-top: none;
      padding: 16px;
      background: #fff;
      border-radius: 0 0 6px 6px;
    }
    .nav-tabs .nav-link {
      border: 1px solid #dee2e6;
      border-bottom-color: transparent;
      border-radius: 0;
      color: #0071e3;
      font-weight: 500;
    }
    .nav-tabs .nav-link.active {
      background-color: #ffffff;
      border-color: #ccc #ccc #fff;
      color: #000;
    }
    .mapper-panels {
      display: flex;
      flex-direction: row;
      gap: 20px;
    }
    .panel-block {
      flex: 1;
      border-radius: 6px;
      background-color: #ffffff;
      padding: 15px;
      border: 1px solid #e0e0e0;
    }
    .table-responsive {
      margin-top: 10px;
    }
    table {
      background-color: #fff;
      border: 1px solid #ccc;
      border-collapse: collapse;
      width: 100%;
    }
    table th, table td {
      border: 1px solid #dee2e6;
      vertical-align: middle;
    }
    .table-sm th, .table-sm td {
      padding: 8px;
    }
    table thead {
      background-color: #f2f2f2;
    }
    .table-sm tbody tr:nth-child(odd) {
      background-color: #ffffff;
    }
    .table-sm tbody tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    table tbody tr:hover {
      background-color: #fafafa;
    }
    .sortable-header {
      cursor: pointer;
      text-decoration: underline;
    }
    .assignBtn {
      margin-top: 12px;
      padding: 8px 14px;
      background-color: #0071e3;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: background-color 0.2s;
    }
    .assignBtn:hover {
      background-color: #005bb5;
    }
    .btn-action {
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 0.9rem;
    }
    .deleteTaxBtn {
      background-color: #dc3545;
      color: #fff;
      border: none;
    }
    .deleteTaxBtn:hover {
      background-color: #bb2d3b;
    }
    .new-map-container {
      position: relative;
    }
    #mapCreationContainer {
      position: absolute;
      top: 48px;
      left: 0;
      display: none;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      z-index: 999;
      width: 320px;
    }
    #cancelMapBtn {
      display: none;
      margin-left: 10px;
    }
    #mapCreationContainer .form-group {
      margin-bottom: 48px;
    }
    .pagination-container {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 10px;
      gap: 10px;
    }
    .pagination-container button {
      border: 1px solid #ccc;
      background: #fff;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
    }
    .pagination-container button:hover {
      background: #eee;
    }
    .pagination-page-info {
      font-weight: 500;
      font-size: 0.85rem;
    }
    .assigned-counter {
      font-size: 1rem;
      margin-top: 1rem;
      font-weight: 500;
    }

    /* ========== Notification Styles ========== */
    #notification-container {
      position: fixed;
      top: 40px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .notification {
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 10px 20px;
      margin-bottom: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      animation: fadein 0.3s ease forwards;
      font-weight: 500;
    }
    .notification.success {
      border-color: #28a745;
    }
    .notification.error {
      border-color: #dc3545;
    }
    .fade-out {
      animation: fadeout 0.5s ease forwards;
    }
    @keyframes fadein {
      0% {
        opacity: 0;
        transform: translateY(-10px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }
    @keyframes fadeout {
      0% {
        opacity: 1;
        transform: translateY(0);
      }
      100% {
        opacity: 0;
        transform: translateY(-10px);
      }
    }

    /* ========== DB Status Indicator ========== */
    .db-status {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      margin: 48px;
      position: fixed;
      bottom: 0px;
      right: 0px;
      font-family: Helvetica,sans-serif;
      font-weight: lighter;
      font-style: italic;
      font-size: 9pt;
      overflow: visible;
    }
    .db-status-green {
      background-color: #28a745;
    }
    .db-status-red {
      background-color: #dc3545;
    }
    .db-status-text {
      position: relative;
      left: -100px;
      width: 200px;
    }
  </style>
</head>

<body>
  <div class="container-fluid">
    <!-- Title & New Map / Delete Mapping / DB Status Indicator -->
    <div class="row align-items-center mb-3">

      <div class="col">
        <h1 class="my-4">Account <-> Tax Code Mapper with Map Names</h1>
      </div>
      <div class="col-auto new-map-container">
        <button class="btn btn-success" id="toggleMapBtn" title="New Map">
          New Map
        </button>
        <button class="btn btn-light" id="cancelMapBtn">Cancel</button>

        <div id="mapCreationContainer">
          <div class="form-inline">
            <div class="form-group mb-2">
              <label for="newMapName" class="sr-only">New Map Name</label>
              <input
                type="text"
                class="form-control"
                id="newMapName"
                placeholder="New Map Name"
                required
              >
            </div>
            <div class="form-group mb-2">
              <label for="copyFromMapName" class="sr-only">Copy from:</label>
              <select class="form-control" id="copyFromMapName">
                <option value="NONE">None (create blank)</option>
              </select>
            </div>
          </div>
        </div>
      </div>
      <!-- DB Status Indicator in the top right -->
      <div class="col-auto">
        <button class="btn btn-danger ml-2" id="deleteMappingBtn" title="Delete a Mapping">
          Delete Mapping
        </button>
      </div>
    </div>

    <!-- Intro text & instructions -->
    <div class="row">
      <div class="col-12">
        <p class="lead">
          Use the tabs below to switch between different <strong>Map Names</strong>.
          Each map name represents a unique chart-of-accounts or budget structure.
        </p>
        <ul>
          <li><strong>Multi-Select</strong> Account Codes on the left, then click “Assign Tax” to link them to a selected tax code.</li>
          <li>We show <strong>40 accounts per page</strong>. Use Prev/Next to navigate.</li>
          <li><strong>Sortable columns</strong>: click “Code,” “Description,” “Linked Tax,” or “Modified” to reorder.</li>
          <li><strong>New Map</strong> toggles a small form. “Cancel” reverts the UI.</li>
          <li><strong>Delete a Mapping</strong> by name, removing all associated AccountCode rows.</li>
        </ul>
      </div>
    </div>

    <!-- Nav Tabs for each map_name -->
    <div class="row mb-3">
      <div class="col-12">
        <ul class="nav nav-tabs" id="mapNameTabs" role="tablist"></ul>
      </div>
    </div>

    <!-- Tab Content -->
    <div class="tab-content" id="mapNameTabsContent"></div>
  </div>

  <div id="dbStatusIndicator" class="db-status db-status-green" title="DB Connection OK">
    <div class="db-status-text"> DB Conn. Status </div>
  </div>

  <!-- Modal for Deleting a Mapping -->
  <div class="modal fade" id="deleteMappingModal" tabindex="-1" role="dialog"
       aria-labelledby="deleteMappingModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deleteMappingModalLabel">Delete Mapping</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span>&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <p>Type the name of the mapping you want to delete:</p>
          <input type="text" class="form-control" id="deleteMappingName" placeholder="Exact Map Name">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirmDeleteMapping">Delete</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Notification Container (for stacked notifications) -->
  <div id="notification-container"></div>

  <!-- Hidden audio elements for notification sounds -->
  <audio id="successSound" src="https://www.soundjay.com/buttons/sounds/button-30.mp3" preload="auto"></audio>
  <audio id="errorSound" src="https://www.soundjay.com/buttons/sounds/button-21.mp3" preload="auto"></audio>

  <!-- Bootstrap + dependencies -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /*
     * 1) On DOM load => fetch map names
     * 2) For each map name => build a tab
     * 3) Multi-select => assign tax => then deselect them
     * 4) Sortable columns => "code_natural", "description", "linked_tax", "updated"
     * 5) Create new map => toggles UI
     * 6) Delete a mapping => remove from DB
     * 7) Show top-middle notifications instead of 'alert()'
     * 8) Update DB status indicator to green or red
    */

    let mapNames = [];
    let creatingMap = false;
    const paginationState = {};

    document.addEventListener("DOMContentLoaded", () => {
      fetchMapNames();
      setupMapCreationUI();
      setupDeleteMapping();
    });

    // ========== Notification Utility ==========
    function showNotification(message, type = 'success') {
      // Create notification element
      const container = document.getElementById('notification-container');
      const notification = document.createElement('div');
      notification.classList.add('notification', type);
      notification.innerText = message;

      container.appendChild(notification);

      // Play appropriate sound
      if (type === 'success') {
        document.getElementById('successSound').play();
      } else {
        document.getElementById('errorSound').play();
      }

      // Fade out and remove after a few seconds
      setTimeout(() => {
        notification.classList.add('fade-out');
        setTimeout(() => {
          if (container.contains(notification)) {
            container.removeChild(notification);
          }
        }, 500);
      }, 3000);
    }

    // ========== DB Status Indicator ==========
    function updateDbStatus(connected) {
      const dbIndicator = document.getElementById('dbStatusIndicator');
      if (!dbIndicator) return;

      if (connected) {
        dbIndicator.classList.remove('db-status-red');
        dbIndicator.classList.add('db-status-green');
        dbIndicator.title = 'DB Connection OK';
      } else {
        dbIndicator.classList.remove('db-status-green');
        dbIndicator.classList.add('db-status-red');
        dbIndicator.title = 'DB Connection ERROR';
      }
    }

    // Fetch map names from server
    function fetchMapNames() {
      fetch("/get_map_names")  // updated route that returns all map_name values
        .then(r => {
          if (!r.ok) throw new Error("Network response was not ok");
          updateDbStatus(true);
          return r.json();
        })
        .then(data => {
          mapNames = data;
          populateMapNameSelect();
          buildTabs();
        })
        .catch(err => {
          updateDbStatus(false);
          showNotification("Error fetching map names: " + err.message, "error");
        });
    }

    // Populate the "Copy from" <select>
    function populateMapNameSelect() {
      const copySelect = document.getElementById("copyFromMapName");
      while (copySelect.options.length > 1) {
        copySelect.remove(1);
      }
      mapNames.forEach(mn => {
        const opt = document.createElement("option");
        opt.value = mn;
        opt.textContent = mn;
        copySelect.appendChild(opt);
      });
    }

    // Create dynamic tabs for each map_name
    function buildTabs() {
      const tabs = document.getElementById("mapNameTabs");
      const tabsContent = document.getElementById("mapNameTabsContent");
      tabs.innerHTML = "";
      tabsContent.innerHTML = "";

      if (!mapNames || mapNames.length === 0) {
        const li = document.createElement("li");
        li.classList.add("nav-item");
        li.innerHTML = `<a class="nav-link active" href="#" role="tab">No Map Names Found</a>`;
        tabs.appendChild(li);
        return;
      }

      let first = true;
      mapNames.forEach(mn => {
        // Generate a slug for the map_name, e.g. "My-Map" => "My-Map"
        const sMn = mn.replace(/\s+/g, '-');
        const tabId = `mapname-${sMn}`;

        // Initialize pagination state
        paginationState[mn] = {
          currentPage: 1,
          totalPages: 1,
          currentSort: "code_natural"
        };

        // Create tab
        const li = document.createElement("li");
        li.classList.add("nav-item");
        const a = document.createElement("a");
        a.classList.add("nav-link");
        if (first) a.classList.add("active");
        a.id = `${tabId}-tab`;
        a.dataset.toggle = "tab";
        a.href = `#${tabId}`;
        a.role = "tab";
        a.setAttribute("aria-controls", tabId);
        a.setAttribute("aria-selected", first ? "true" : "false");
        a.textContent = mn;
        li.appendChild(a);
        tabs.appendChild(li);

        // Create pane
        const pane = document.createElement("div");
        pane.classList.add("tab-pane", "fade");
        if (first) pane.classList.add("show", "active");
        pane.id = tabId;
        pane.setAttribute("role", "tabpanel");
        pane.setAttribute("aria-labelledby", `${tabId}-tab`);

        pane.innerHTML = `
          <div class="mapper-panels mt-3">
            <div class="panel-block" id="accountPanel-${sMn}">
              <h4>Account Codes</h4>
              <div class="table-responsive mt-2">
                <table id="accountTable-${sMn}" class="table table-sm">
                  <thead>
                    <tr>
                      <th>Select</th>
                      <th class="sortable-header" id="acctCodeHeader-${sMn}">Code</th>
                      <th class="sortable-header" id="acctDescHeader-${sMn}">Description</th>
                      <th class="sortable-header" id="acctTaxHeader-${sMn}">Linked Tax</th>
                      <!-- New Modified column -->
                      <th class="sortable-header" id="acctModifiedHeader-${sMn}">Modified</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
                <div class="assigned-counter" id="assignedCount-${sMn}"></div>
              </div>
              <div class="pagination-container">
                <button id="prevPage-${sMn}">Prev</button>
                <span class="pagination-page-info" id="pageIndicator-${sMn}">Page 1 of 1</span>
                <button id="nextPage-${sMn}">Next</button>
              </div>
            </div>
            <div class="panel-block" id="taxPanel-${sMn}">
              <h4>Tax Codes</h4>
              <div class="table-responsive mt-2">
                <table id="taxTable-${sMn}" class="table table-sm">
                  <thead>
                    <tr>
                      <th>Select</th>
                      <th>Tax Code</th>
                      <th>Description</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
              <button class="assignBtn" id="assignBtn-${sMn}">Assign Tax to Selected Accounts</button>
              <h5 class="mt-4">Create New Tax Code</h5>
              <form class="form-inline" id="newTaxForm-${sMn}">
                <div class="form-group mb-2">
                  <label class="sr-only" for="newTaxCode-${sMn}">Tax Code</label>
                  <input type="text" class="form-control" id="newTaxCode-${sMn}" placeholder="Tax Code" required>
                </div>
                <div class="form-group mx-sm-3 mb-2">
                  <label class="sr-only" for="newTaxDesc-${sMn}">Description</label>
                  <input type="text" class="form-control" id="newTaxDesc-${sMn}" placeholder="Description">
                </div>
                <button type="submit" class="btn btn-secondary btn-action mb-2">Create</button>
              </form>
            </div>
          </div>
        `;

        tabsContent.appendChild(pane);
        if (first) first = false;

        loadAccountsAndTaxes(mn, sMn, 1);
        setupPagination(mn, sMn);
        setupColumnSorting(mn, sMn);
      });
    }

    // Load the account + tax data for a given mapName
    function loadAccountsAndTaxes(mapName, sMn, pageNum) {
      const st = paginationState[mapName];
      const sortKey = st.currentSort || "code_natural";

      // e.g., /get_map_data?map_name=Sales&sort_by=code_natural
      const url = `/get_map_data?map_name=${encodeURIComponent(mapName)}`
        + `&page_account=${pageNum}`
        + `&per_page_account=40`
        + `&sort_by=${sortKey}`;

      fetch(url)
        .then(r => {
          if (!r.ok) throw new Error("Network response was not ok");
          updateDbStatus(true);
          return r.json();
        })
        .then(data => {
          st.currentPage = data.page_account || 1;
          st.totalPages = data.total_pages_account || 1;
          updatePageIndicator(mapName, sMn);

          fillAccountTable(mapName, sMn, data.account_records);
          fillTaxTable(mapName, sMn, data.tax_records || []);
          updateAssignedCounter(sMn, data.account_records);

          bindAssignButton(mapName, sMn);
          bindNewTaxForm(mapName, sMn);
        })
        .catch(err => {
          updateDbStatus(false);
          showNotification(`Error loading data for mapName="${mapName}": ` + err.message, "error");
        });
    }

    // Fill the left (accounts) table
    function fillAccountTable(mapName, sMn, rows) {
      const tb = document.querySelector(`#accountTable-${sMn} tbody`);
      tb.innerHTML = "";
      if (!rows || rows.length === 0) {
        tb.innerHTML = `<tr><td colspan="5"><em>No accounts for ${mapName}.</em></td></tr>`;
        return;
      }
      rows.forEach(acc => {
        const tr = document.createElement("tr");
        tr.dataset.accountId = acc.id;
        tr.dataset.taxId = acc.tax_id || "";
        tr.innerHTML = `
          <td><input type="checkbox" name="acctSel-${sMn}" value="${acc.id}"></td>
          <td>${acc.code || ""}</td>
          <td>${acc.account_description || ""}</td>
          <td class="linkedTaxCode">${acc.tax_code || "(None)"}</td>
          <td>${acc.updated_at ? new Date(acc.updated_at).toLocaleString() : ""}</td>
        `;
        tb.appendChild(tr);
      });
    }

    // Fill the right (tax) table
    function fillTaxTable(mapName, sMn, rows) {
      const tb = document.querySelector(`#taxTable-${sMn} tbody`);
      tb.innerHTML = "";
      if (!rows || rows.length === 0) {
        tb.innerHTML = `<tr><td colspan="4"><em>No tax codes found.</em></td></tr>`;
        return;
      }
      rows.forEach(tax => {
        const tr = document.createElement("tr");
        tr.dataset.taxId = tax.id;
        tr.innerHTML = `
          <td><input type="radio" name="taxSel-${sMn}" value="${tax.id}"></td>
          <td contenteditable="true" class="taxCodeCell">${tax.tax_code}</td>
          <td contenteditable="true" class="taxDescCell">${tax.description || ""}</td>
          <td><button class="deleteTaxBtn btn-action">Delete</button></td>
        `;
        tb.appendChild(tr);

        // When user leaves the cell, update DB
        tr.addEventListener("focusout", evt => {
          if (
            evt.target.classList.contains("taxCodeCell") ||
            evt.target.classList.contains("taxDescCell")
          ) {
            const newCode = tr.querySelector(".taxCodeCell").innerText.trim();
            const newDesc = tr.querySelector(".taxDescCell").innerText.trim();
            updateTax(mapName, tax.id, newCode, newDesc);
          }
        });
        // Deletion
        tr.querySelector(".deleteTaxBtn").addEventListener("click", () => {
          deleteTax(mapName, tax.id, sMn);
        });
      });
    }

    // Show how many accounts have a tax_id set
    function updateAssignedCounter(sMn, accountRows) {
      const assigned = accountRows.filter(ar => ar.tax_id != null && ar.tax_id !== "").length;
      const total = accountRows.length;
      document.getElementById(`assignedCount-${sMn}`).textContent = `Assigned: ${assigned} / ${total}`;
    }

    // Update a single Tax record
    function updateTax(mapName, taxId, taxCode, taxDesc) {
      fetch("/update_tax", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          map_name: mapName,
          tax_id: taxId,
          tax_code: taxCode,
          tax_description: taxDesc
        })
      })
        .then(r => {
          if (!r.ok) throw new Error("Network response was not ok");
          updateDbStatus(true);
          return r.json();
        })
        .then(d => {
          if (d.status !== "success") {
            showNotification("Error updating tax: " + d.message, "error");
          } else {
            showNotification("Tax updated successfully!", "success");
          }
        })
        .catch(err => {
          updateDbStatus(false);
          showNotification("Update tax request error: " + err.message, "error");
        });
    }

    // Delete a Tax record
    function deleteTax(mapName, taxId, sMn) {
      if (!confirm(`Are you sure you want to delete Tax ID=${taxId}?`)) return;

      fetch("/delete_tax", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ map_name: mapName, tax_id: taxId })
      })
      .then(r => {
        if (!r.ok) throw new Error("Network response was not ok");
        updateDbStatus(true);
        return r.json();
      })
      .then(d => {
        if (d.status === "success") {
          showNotification("Tax deleted!", "success");
          // Remove row from the table
          const row = document.querySelector(`#taxTable-${sMn} tr[data-tax-id="${taxId}"]`);
          if (row) row.remove();
          // Clear references from any accounts in the UI
          document.querySelectorAll(`#accountTable-${sMn} tr[data-tax-id="${taxId}"]`)
            .forEach(accRow => {
              accRow.dataset.taxId = "";
              const linkedCell = accRow.querySelector(".linkedTaxCode");
              if (linkedCell) linkedCell.textContent = "(None)";
            });
          // Recount
          const allAccounts = Array.from(document.querySelectorAll(`#accountTable-${sMn} tbody tr`))
            .map(tr => ({
              tax_id: tr.dataset.taxId,
              code: tr.children[1]?.textContent || ""
            }));
          updateAssignedCounter(sMn, allAccounts);
        } else {
          showNotification("Error deleting tax: " + d.message, "error");
        }
      })
      .catch(err => {
        updateDbStatus(false);
        showNotification("Delete tax error: " + err.message, "error");
      });
    }

    // Assign tax to multiple accounts
    function bindAssignButton(mapName, sMn) {
      const btn = document.getElementById(`assignBtn-${sMn}`);
      if (!btn) return;
      btn.addEventListener("click", () => {
        const checkedAccounts = document.querySelectorAll(`input[name="acctSel-${sMn}"]:checked`);
        if (!checkedAccounts || checkedAccounts.length === 0) {
          showNotification("Select one or more accounts.", "error");
          return;
        }
        const selectedTax = document.querySelector(`input[name="taxSel-${sMn}"]:checked`);
        if (!selectedTax) {
          showNotification("Select a tax code on the right.", "error");
          return;
        }
        const taxVal = selectedTax.value;
        const acctIds = Array.from(checkedAccounts).map(c => c.value);

        fetch("/assign_tax_bulk", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ map_name: mapName, account_ids: acctIds, tax_id: taxVal })
        })
          .then(r => {
            if (!r.ok) throw new Error("Network response was not ok");
            updateDbStatus(true);
            return r.json();
          })
          .then(d => {
            if (d.status === "success") {
              showNotification("Tax assigned!", "success");
              acctIds.forEach(aid => {
                const row = document.querySelector(`#accountTable-${sMn} tr[data-account-id="${aid}"]`);
                if (row) {
                  row.dataset.taxId = taxVal;
                  const linkCell = row.querySelector(".linkedTaxCode");
                  const taxRow = document.querySelector(`#taxTable-${sMn} tr[data-tax-id="${taxVal}"] .taxCodeCell`);
                  if (taxRow) {
                    linkCell.textContent = taxRow.innerText.trim() || "(None)";
                  }
                }
              });
              // Deselect all accounts
              checkedAccounts.forEach(chk => { chk.checked = false; });

              // Update assigned count
              const allAccounts = Array.from(document.querySelectorAll(`#accountTable-${sMn} tbody tr`))
                .map(tr => ({
                  tax_id: tr.dataset.taxId,
                  code: tr.children[1]?.textContent || ""
                }));
              updateAssignedCounter(sMn, allAccounts);
            } else {
              showNotification("Error assigning tax: " + d.message, "error");
            }
          })
          .catch(err => {
            updateDbStatus(false);
            showNotification("Assign tax error: " + err.message, "error");
          });
      });
    }

    // Form to create a new Tax code
    function bindNewTaxForm(mapName, sMn) {
      const form = document.getElementById(`newTaxForm-${sMn}`);
      if (!form) return;
      form.addEventListener("submit", e => {
        e.preventDefault();
        const codeField = document.getElementById(`newTaxCode-${sMn}`);
        const descField = document.getElementById(`newTaxDesc-${sMn}`);
        const newCode = codeField.value.trim();
        const newDesc = descField.value.trim();
        if (!newCode) {
          showNotification("Tax Code is required.", "error");
          return;
        }

        fetch("/create_tax", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            map_name: mapName,
            tax_code: newCode,
            tax_description: newDesc
          })
        })
          .then(r => {
            if (!r.ok) throw new Error("Network response was not ok");
            updateDbStatus(true);
            return r.json();
          })
          .then(d => {
            if (d.status === "success") {
              showNotification("Tax code created!", "success");
              addTaxRow(mapName, sMn, d.id, newCode, newDesc);
              codeField.value = "";
              descField.value = "";
            } else {
              showNotification("Error creating tax code: " + d.message, "error");
            }
          })
          .catch(err => {
            updateDbStatus(false);
            showNotification("Create tax error: " + err.message, "error");
          });
      });
    }

    // Add the newly created Tax row to the table
    function addTaxRow(mapName, sMn, taxId, tCode, tDesc) {
      const tb = document.querySelector(`#taxTable-${sMn} tbody`);
      const tr = document.createElement("tr");
      tr.dataset.taxId = taxId;
      tr.innerHTML = `
        <td><input type="radio" name="taxSel-${sMn}" value="${taxId}"></td>
        <td contenteditable="true" class="taxCodeCell">${tCode}</td>
        <td contenteditable="true" class="taxDescCell">${tDesc}</td>
        <td><button class="deleteTaxBtn btn-action">Delete</button></td>
      `;
      tb.appendChild(tr);

      tr.addEventListener("focusout", evt => {
        if (
          evt.target.classList.contains("taxCodeCell") ||
          evt.target.classList.contains("taxDescCell")
        ) {
          const newCode = tr.querySelector(".taxCodeCell").innerText.trim();
          const newDesc = tr.querySelector(".taxDescCell").innerText.trim();
          updateTax(mapName, taxId, newCode, newDesc);
        }
      });
      tr.querySelector(".deleteTaxBtn").addEventListener("click", () => {
        deleteTax(mapName, taxId, sMn);
      });
    }

    // Pagination
    function setupPagination(mapName, sMn) {
      const prevBtn = document.getElementById(`prevPage-${sMn}`);
      const nextBtn = document.getElementById(`nextPage-${sMn}`);
      if (prevBtn) {
        prevBtn.addEventListener("click", () => {
          const st = paginationState[mapName];
          if (st.currentPage > 1) {
            st.currentPage -= 1;
            loadAccountsAndTaxes(mapName, sMn, st.currentPage);
          }
        });
      }
      if (nextBtn) {
        nextBtn.addEventListener("click", () => {
          const st = paginationState[mapName];
          if (st.currentPage < st.totalPages) {
            st.currentPage += 1;
            loadAccountsAndTaxes(mapName, sMn, st.currentPage);
          }
        });
      }
    }

    function updatePageIndicator(mapName, sMn) {
      const lbl = document.getElementById(`pageIndicator-${sMn}`);
      const st = paginationState[mapName];
      lbl.textContent = `Page ${st.currentPage} of ${st.totalPages}`;
    }

    function setupColumnSorting(mapName, sMn) {
      const codeHead = document.getElementById(`acctCodeHeader-${sMn}`);
      const descHead = document.getElementById(`acctDescHeader-${sMn}`);
      const taxHead = document.getElementById(`acctTaxHeader-${sMn}`);
      const modHead = document.getElementById(`acctModifiedHeader-${sMn}`);

      codeHead?.addEventListener("click", () => {
        paginationState[mapName].currentSort = "code_natural";
        paginationState[mapName].currentPage = 1;
        loadAccountsAndTaxes(mapName, sMn, 1);
      });
      descHead?.addEventListener("click", () => {
        paginationState[mapName].currentSort = "description";
        paginationState[mapName].currentPage = 1;
        loadAccountsAndTaxes(mapName, sMn, 1);
      });
      taxHead?.addEventListener("click", () => {
        paginationState[mapName].currentSort = "linked_tax";
        paginationState[mapName].currentPage = 1;
        loadAccountsAndTaxes(mapName, sMn, 1);
      });
      modHead?.addEventListener("click", () => {
        paginationState[mapName].currentSort = "updated";
        paginationState[mapName].currentPage = 1;
        loadAccountsAndTaxes(mapName, sMn, 1);
      });
    }

    // UI for creating a new Map
    function setupMapCreationUI() {
      const toggleBtn = document.getElementById("toggleMapBtn");
      const cancelBtn = document.getElementById("cancelMapBtn");
      const createBox = document.getElementById("mapCreationContainer");

      toggleBtn.addEventListener("click", () => {
        if (!creatingMap) {
          // Switch to "Create" mode
          creatingMap = true;
          toggleBtn.textContent = "Create Map";
          toggleBtn.classList.remove("btn-success");
          toggleBtn.classList.add("btn-primary");
          cancelBtn.style.display = "inline-block";
          createBox.style.display = "block";
          document.getElementById("newMapName").focus();
        } else {
          // We are confirming creation
          const newMap = document.getElementById("newMapName").value.trim();
          const copyVal = document.getElementById("copyFromMapName").value;
          if (!newMap) {
            showNotification("Please enter a new map name!", "error");
            return;
          }
          fetch("/create_map_code", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              new_map_code: newMap,
              copy_from: copyVal === "NONE" ? "" : copyVal
            })
          })
            .then(r => {
              if (!r.ok) throw new Error("Network response was not ok");
              updateDbStatus(true);
              return r.json();
            })
            .then(d => {
              if (d.status === "success") {
                showNotification(`Map "${newMap}" created!`, "success");
                resetMapCreateUI();
                fetchMapNames();
              } else {
                showNotification("Error creating map: " + d.message, "error");
              }
            })
            .catch(err => {
              updateDbStatus(false);
              showNotification("Create map request error: " + err.message, "error");
            });
        }
      });

      cancelBtn.addEventListener("click", resetMapCreateUI);

      function resetMapCreateUI() {
        creatingMap = false;
        toggleBtn.textContent = "New Map";
        toggleBtn.classList.remove("btn-primary");
        toggleBtn.classList.add("btn-success");
        cancelBtn.style.display = "none";
        createBox.style.display = "none";
        document.getElementById("newMapName").value = "";
      }
    }

    // UI for deleting a Map
    function setupDeleteMapping() {
      document.getElementById("deleteMappingBtn").addEventListener("click", () => {
        $('#deleteMappingModal').modal('show');
      });

      document.getElementById("confirmDeleteMapping").addEventListener("click", () => {
        const mapName = document.getElementById("deleteMappingName").value.trim();
        if (!mapName) {
          showNotification("Please enter a map name to delete.", "error");
          return;
        }
        fetch("/delete_mapping", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ map_name: mapName })
        })
          .then(r => {
            if (!r.ok) throw new Error("Network response was not ok");
            updateDbStatus(true);
            return r.json();
          })
          .then(d => {
            if (d.status === "success") {
              showNotification(`Mapping "${mapName}" was deleted.`, "success");
              $('#deleteMappingModal').modal('hide');
              document.getElementById("deleteMappingName").value = "";
              fetchMapNames();
            } else {
              showNotification("Error deleting mapping: " + d.message, "error");
            }
          })
          .catch(err => {
            updateDbStatus(false);
            showNotification("Delete mapping request error: " + err.message, "error");
          });
      });
    }
  </script>
</body>
</html>